<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>四达时代网络监控-OTT</title>
  <link rel="stylesheet" href="./css/bossStatus.css?version=1528769604144">
  <link rel="stylesheet" href="./css/boosFont/bossIconfont.css?version=1528769604144">
  <script src="./js/jquery.min.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/grafana.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/template-web.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/moment.js?version=1528769604144" charset="utf-8"></script>
  <script src="./js/moment-timezone-with-data.min.js?version=1528769604144" charset="utf-8"></script>
  <script src="./config/boss-contry.js?version=1528769604144" charset="utf-8"></script>
</head>
<body>
  <div class="bossPage">
    <div class="sassList">
      <div class="listPanel" style="margin-top:55px;">
        <div class="sassTitle">
          <div class="title">
            <div class="titleImage">
              <img src="img/boss/Cloud%20server.png" alt="">
            </div>
            <div class="titleName">BOSS</div>
          </div>
        </div>
        <ul class="sassContent">
          <li>
            <p>微服务状态</p>
            <p class="sassContentFirstList"><span id="bossSuccess"></span>/<span id="bossTotal"></span></p>
          </li>
          <li>
            <p>系统接入状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont">系统请求数:<span id="systemTotal"></span></p>
              <p class="sassLiContentFont">请求错误率:<span id="systemPersent"></span>%</p>
            </div>
          </li>
          <li>
            <p>CA指令状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont">堆积指令:<span id="caTotal"></span></p>
              <p class="sassLiContentFont">失败指令:<span id="caError"></span></p>
            </div>
          </li>
          <li>
            <p>短信下发状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont single">失败短信：<span id="msgError"></span></p>
            </div>
          </li>
          <li>
            <p>支付状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont single">最近30分钟支付：<span id="payTotal"></span></p>
            </div>
          </li>
          <li>
            <p>营业状态</p>
            <div class="sassLiContentFont">
              <p class="sassLiContentFont single">最近30分钟：???</p>
            </div>
          </li>
        </ul>
        <div class='sassPlaceHolder'></div>
      </div>
      <div class="listPanel">
        <div class="iaasTitle">
          <p></p>
        </div>
        <ul class="iaasContent">
          <li>
            <i class="iconfont icon-dec2"></i>
            <p>云主机</p>
          </li>
          <li>
            <i class="iconfont icon-KS"></i>
            <p>集群平台</p>
          </li>
          <li>
            <i class="iconfont icon-database"></i>
            <p>数据库</p>
          </li>
          <li>
            <i class="iconfont icon-yunxiazai1"></i>
            <p>系统缓存</p>
          </li>
          <li>
            <i class="iconfont icon-xiaoxiduilieMQ"></i>
            <p>消息队列</p>
          </li>
          <li>
            <i class="iconfont icon-xiaoxiguanli"></i>
            <p>消息通知</p>
          </li>
          <li>
            <i class="iconfont icon-jingxiangku"></i>
            <p>发布镜像库</p>
          </li>
          <li>
            <i class="iconfont icon-peizhiguanli"></i>
            <p>配置管理</p>
          </li>
          <li>
            <i class="iconfont icon-shujuku"></i>
            <p>数据备份</p>
          </li>
        </ul>
        <div class="iassPlaceHolder">
        </div>
      </div>
    </div>
    <div class="cloudImgWrap">
      <div class="cloudline"><div class="line"></div></div>
      <div class="cloud"></div>
      <div class="vpn">VPN</div>
      <div class="stat">
        <div class="stat-item">
          <div class="title">运营国家</div>
          <div class="num" id="countryNum"></div>
        </div>
        <div class="stat-item">
          <div class="title">在线终端</div>
          <div class="num">541</div>
        </div>
      </div>
      <div class="wrap-bg"></div>
      <div class="wrap-icon">
        <span><i></i></span>
      </div>
      <div class="wrap-bg wrap-bg2"></div>
      <div class="wrap-icon wrap-icon2">
        <span><i></i></span>
      </div>
      <div class="wrap-bg wrap-bg3"></div>
      <div class="wrap-icon wrap-icon3">
        <span><i></i></span>
      </div>
      <div class="countryLine">
        <div class="itemLine itemLine1"></div>
        <div class="itemLine itemLine2"></div>
        <div class="itemLine itemLine3"></div>
        <div class="itemLine itemLine4"></div>
      </div>
    </div>
  </div>
  <div class="countryGroupWrap">
    <div class="countryGroup">
      <div class="countryTitle">
        <p>东非</p>
      </div>
      <div id="eastAfrica">
      </div>
    </div>
    <div class="countryGroup">
      <div class="countryTitle">
        <p>西非</p>
      </div>
      <div id="westAfrica">
      </div>
    </div>
    <div class="countryGroup">
      <div class="countryTitle">
        <p>中非</p>
      </div>
      <div id="centerAfrica">
      </div>
    </div>
    <div class="countryGroup">
      <div class="countryTitle">
        <p>南非</p>
      </div>
      <div id="southAfirca">
      </div>
    </div>
  </div>
  </div>
  <script id="countryTpl" type="text/html">
    <div class="countryItem" onclick="goto('{{url}}')">
      <div class="countryImg">
        <img src="img/country/{{enName}}.jpg" alt="">
      </div>
      <div class="countryName">
        <div class="name">{{name}}</div>
      </div>
      <div class="countryTime">
        {{time}}
      </div>
      <div class="countryStatus">
        <div class="light {{if status=='none'}}none{{else if status=='good'}}good{{else}}error{{/if}}-light"></div>
      </div>
    </div>
  </script>
  <script type="text/javascript">
    var grafana_server = new $.jqgrafana(), bossStatus = {}, color = ['#30af81', '#d1d41a', '#ff1d04']
    moment.locale('zh_cn')
    $('#countryNum').html(westAfrica.length + eastAfrica.length + centerAfrica.length + southAfirca.length)
    task()
    // 总的任务调度
    function task(){
      getBossStatus()
      getCountryStatus()
    }
    // 获取boss各项服务状态
    function getBossStatus(){
      grafana_server.queryData('alerts?state=all', 'GET', null, function(res) {
        bossStatus = {}
        res.forEach(function(item) {
          if (item.name.indexOf('微服务状态-EC2-BOSS') >= 0) {
            if (bossStatus.status == undefined) {
              bossStatus.status = {
                success: 0,
                total: 0
              }
            }
            bossStatus.status.total += 1
            if (item.state == 'ok') {
              bossStatus.status.success += 1
            }
          } else if (item.name.indexOf('业务状态-BOSS-CA-') >= 0) {
            if (bossStatus.ca == undefined) {
              bossStatus.ca = {
                success: 0,
                total: 0
              }
            }
            bossStatus.ca.total += 1
            if (item.state == 'ok') {
              bossStatus.ca.success += 1
            }
          } else if (item.name.indexOf('业务状态-BOSS-短信-') >= 0) {
            if (bossStatus.msg == undefined) {
              bossStatus.msg = {
                success: 0,
                total: 0
              }
            }
            bossStatus.msg.total += 1
            if (item.state == 'ok') {
              bossStatus.msg.success += 1
            }
          } else if (item.name.indexOf('业务状态-BOSS-支付-') >= 0) {
            if (bossStatus.pay == undefined) {
              bossStatus.pay = {
                success: 0,
                total: 0
              }
            }
            bossStatus.pay.total += 1
            if (item.state == 'ok') {
              bossStatus.pay.success += 1
            }
          } else if (item.name.indexOf('基础服务-系统缓存-') >= 0) {
            if (bossStatus.cache == undefined) {
              bossStatus.cache = {
                success: 0,
                total: 0
              }
            }
            bossStatus.cache.total += 1
            if (item.state == 'ok') {
              bossStatus.cache.success += 1
            }
          } else if (item.name.indexOf('基础服务-EC2HOST-') >= 0) {
            if (bossStatus.EC2 == undefined) {
              bossStatus.EC2 = {
                success: 0,
                total: 0
              }
            }
            bossStatus.EC2.total += 1
            if (item.state == 'ok') {
              bossStatus.EC2.success += 1
            }
          } else if (item.name.indexOf('基础服务-BOSSDB') >= 0) {
            if (bossStatus.BOSSDB == undefined) {
              bossStatus.BOSSDB = {
                success: 0,
                total: 0
              }
            }
            bossStatus.BOSSDB.total += 1
            if (item.state == 'ok') {
              bossStatus.BOSSDB.success += 1
            }
          } else if (item.name.indexOf('基础服务-K8s') >= 0) {
            if (bossStatus.K8s == undefined) {
              bossStatus.K8s = {
                success: 0,
                total: 0
              }
            }
            bossStatus.K8s.total += 1
            if (item.state == 'ok') {
              bossStatus.K8s.success += 1
            }
          } else {
            // console.log(item)
          }
        })
        $('#bossTotal').text(bossStatus.status.total)
        $('#bossSuccess').text(bossStatus.status.success)
        if (bossStatus.EC2.success === bossStatus.EC2.total) {
          $('.icon-dec2').css('color', color[0])
        } else {
          $('.icon-dec2').css('color', color[2])
        }
        if (bossStatus.K8s.success === bossStatus.K8s.total) {
          $('.icon-KS').css('color', color[0])
          } else {
          $('.icon-KS').css('color', color[2])
        }
        if (bossStatus.BOSSDB.success === bossStatus.BOSSDB.total) {
          $('.icon-database').css('color', color[0])
          } else {
          $('.icon-database').css('color', color[2])
        }
        if (bossStatus.cache.success === bossStatus.cache.total) {
          $('.icon-yunxiazai1').css('color', color[0])
          } else {
          $('.icon-yunxiazai1').css('color', color[2])
        }
        if (bossStatus.msg.success === bossStatus.msg.total) {
          $('.icon-xiaoxiduilieMQ').css('color', color[0])
          } else {
          $('.icon-xiaoxiduilieMQ').css('color', color[2])
        }
      })
    }
    // 渲染国家列表
    function getCountryStatus(){
      handlerCountry('westAfrica', westAfrica)
      handlerCountry('eastAfrica', eastAfrica)
      handlerCountry('centerAfrica', centerAfrica)
      handlerCountry('southAfirca', southAfirca)
    }
    function handlerCountry(id, list){
      $('#' + id).html('')
      list.forEach(function (item) {
        if (item.name.split('').length <= 3) {
          item.name = item.name.split('').join(' ')
        }
        item.time = moment().tz(item.timezone).format('HH:mm')
        if (item.uid != undefined) {
          grafana_server.queryData('dashboards/uid/' + item.uid, 'GET', null, function(res) {
            item.url = grafana_server.getOptions('url').replace('api/', res.meta.url)
            console.log(item.url)
            item.id = res.dashboard.id
            grafana_server.queryData('alerts?dashboardId=' + item.id, 'GET', null, function(res) {
              item.status = 'good'
              res.forEach(function(_val) {
                if (_val.state != 'ok') {
                  item.status = 'bad'
                }
              })
              $('#' + id).append(template('countryTpl', item))
            })
          })
        } else {
          item.status = 'none'
          $('#' + id).append(template('countryTpl', item))
        }
      })
    }
    function goto(url) {
      if (url !== undefined) {
        location.href = url
      }
    }
  </script>
</body>

</html>
